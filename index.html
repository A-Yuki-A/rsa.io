<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>PrimeGuard RSA â€“ ä½“é¨“ãƒ„ãƒ¼ãƒ«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
    <div class="hero">
      <div class="hero-title">
        <div class="hero-logo">PG</div>
        <div>
          <h1>PrimeGuard RSA â€“ ä½“é¨“ãƒ„ãƒ¼ãƒ«</h1>
          <div class="hero-sub">
            2 ã¤ã®ç´ æ•° <code>p, q</code> ã‹ã‚‰ RSA ã®éµã‚’ä½œã‚Šã€<br />
            Aã€œZ ã¨ 0ã€œ9 ã®æ–‡å­—ï¼ˆæœ€å¤§5æ–‡å­—ï¼‰ã‚’æš—å·åŒ–ãƒ»å¾©å·ã§ãã¾ã™ã€‚
          </div>
          <div class="hero-badge">
            <span>ğŸ” å­¦ç¿’ç”¨</span>
            <span>p, q ã¯ 5000ã€œ6000 ã®ç´ æ•°</span>
          </div>
        </div>
      </div>

      <div style="margin-top:14px;">
        <div style="font-size:0.8rem; color:#cbd5f5; margin-bottom:4px;">å½¹å‰²ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div class="role-tabs">
          <label class="role-tab active" data-role="receiver">
            <input type="radio" name="role" value="receiver" checked>
            <span class="dot"></span> å—ä¿¡è€…ï¼ˆéµã‚’ä½œã‚‹å´ï¼‰
          </label>
          <label class="role-tab" data-role="sender">
            <input type="radio" name="role" value="sender">
            <span class="dot"></span> é€ä¿¡è€…ï¼ˆå…¬é–‹éµã‚’ä½¿ã†å´ï¼‰
          </label>
          <label class="role-tab" data-role="solo">
            <input type="radio" name="role" value="solo">
            <span class="dot"></span> ä¸€äººã§ç·´ç¿’
          </label>
        </div>
      </div>
    </div>

    <!-- å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ -->
    <div class="card" id="receiver-section">
      <h2><span class="step-tag">STEP 1</span> éµç”Ÿæˆï¼ˆå—ä¿¡è€…ï¼‰</h2>
      <p>è‡ªåˆ†ã§ <code>p, q</code> ã‚’é¸ã³ã€å…¬é–‹éµ <code>(n, e)</code> ã¨ç§˜å¯†éµ <code>d</code> ã‚’ä½œã‚Šã¾ã™ã€‚</p>

      <div class="row">
        <div class="col">
          <label for="recv-p">ç´ æ•° p</label>
          <select id="recv-p"></select>
        </div>
        <div class="col">
          <label for="recv-q">ç´ æ•° q</label>
          <select id="recv-q"></select>
        </div>
        <div class="col">
          <label>å…¬é–‹éµ eï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
          <div id="recv-e-display"><code>æœªè¨ˆç®—</code></div>
        </div>
      </div>

      <button id="recv-generate-btn">éµç”Ÿæˆ</button>
      <div id="recv-generate-msg"></div>

      <div id="recv-keys" style="margin-top:10px; display:none;">
        <div class="field-line">
          <span class="label">å…¬é–‹éµ n</span>
          <span class="value" id="recv-n"></span>
          <button class="copy-btn secondary" data-copy-target="recv-n">Copy</button>
        </div>
        <div class="field-line">
          <span class="label">å…¬é–‹éµ e</span>
          <span class="value" id="recv-e"></span>
          <button class="copy-btn secondary" data-copy-target="recv-e">Copy</button>
        </div>
        <div class="field-line">
          <span class="label">ç§˜å¯†éµ d</span>
          <span class="value" id="recv-d"></span>
          <button class="copy-btn secondary" data-copy-target="recv-d">Copy</button>
        </div>
      </div>

      <hr />

      <h2><span class="step-tag">STEP 2</span> å¾©å·ï¼ˆå—ä¿¡è€…ï¼‰</h2>
      <p>é€ã‚‰ã‚Œã¦ããŸæš—å·æ–‡ï¼ˆBase64ï¼‰ã‚’ã€ç§˜å¯†éµ <code>(n, d)</code> ã§å¾©å·ã—ã¾ã™ã€‚</p>
      <div class="row">
        <div class="col">
          <label for="dec-n">å…¬é–‹éµ n</label>
          <input type="text" id="dec-n" placeholder="n ã‚’è²¼ã‚Šä»˜ã‘">
        </div>
        <div class="col">
          <label for="dec-d">ç§˜å¯†éµ d</label>
          <input type="text" id="dec-d" placeholder="d ã‚’è²¼ã‚Šä»˜ã‘">
        </div>
        <div class="col">
          <label for="dec-c">æš—å·æ–‡ (Base64)</label>
          <textarea id="dec-c" placeholder="æš—å·æ–‡ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
        </div>
      </div>
      <button id="dec-btn">å¾©å·</button>
      <div id="dec-msg"></div>
    </div>

    <!-- é€ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ -->
    <div class="card" id="sender-section" style="display:none;">
      <h2><span class="step-tag">STEP</span> é€ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰</h2>
      <p>
        å—ä¿¡è€…ã‹ã‚‰æ¸¡ã•ã‚ŒãŸå…¬é–‹éµ <code>(n, e)</code> ã¨è‡ªåˆ†ã®å¹³æ–‡ã‚’ä½¿ã£ã¦ã€æš—å·æ–‡ï¼ˆBase64ï¼‰ã‚’ä½œã‚Šã¾ã™ã€‚<br>
        ä½œã£ãŸæš—å·æ–‡ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€å—ä¿¡è€…ã«é€ã‚Šã¾ã™ã€‚
      </p>

      <h3>1. å…¬é–‹éµã¨å¹³æ–‡ã®å…¥åŠ›</h3>
      <div class="row">
        <div class="col">
          <label for="sender-enc-n">å…¬é–‹éµ n</label>
          <input type="text" id="sender-enc-n" placeholder="å—ä¿¡è€…ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ n">
        </div>
        <div class="col">
          <label for="sender-enc-e">å…¬é–‹éµ e</label>
          <input type="text" id="sender-enc-e" placeholder="å—ä¿¡è€…ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ e">
        </div>
        <div class="col">
          <label for="sender-plain">å¹³æ–‡ (Aã€œZ, 0ã€œ9 / æœ€å¤§5æ–‡å­—)</label>
          <input type="text" id="sender-plain" maxlength="5" placeholder="ä¾‹: HELLO">
        </div>
      </div>

      <button id="sender-enc-btn">æš—å·åŒ–</button>
      <div id="sender-enc-output"></div>
    </div>

    <!-- ä¸€äººã§è¡Œã†ãƒ¢ãƒ¼ãƒ‰ -->
    <div class="card" id="solo-section" style="display:none;">
      <h2><span class="step-tag">ALL</span> éµç”Ÿæˆ â†’ æš—å·åŒ– â†’ å¾©å·ï¼ˆ1äººã§é€šã—ç·´ç¿’ï¼‰</h2>
      <p>è‡ªåˆ†ä¸€äººã§ã€éµç”Ÿæˆãƒ»æš—å·åŒ–ãƒ»å¾©å·ã®æµã‚Œã‚’ã¾ã¨ã‚ã¦ç¢ºèªã™ã‚‹ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚</p>

      <!-- éµç”Ÿæˆ -->
      <h3>1. éµç”Ÿæˆ</h3>
      <div class="row">
        <div class="col">
          <label for="solo-p">ç´ æ•° p</label>
          <select id="solo-p"></select>
        </div>
        <div class="col">
          <label for="solo-q">ç´ æ•° q</label>
          <select id="solo-q"></select>
        </div>
        <div class="col">
          <label>å…¬é–‹éµ eï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
          <div id="solo-e-display"><code>æœªè¨ˆç®—</code></div>
        </div>
      </div>
      <button id="solo-generate-btn">éµç”Ÿæˆ</button>
      <div id="solo-generate-msg"></div>

      <div id="solo-keys" style="margin-top:10px; display:none;">
        <div class="field-line">
          <span class="label">å…¬é–‹éµ n</span>
          <span class="value" id="solo-n"></span>
          <button class="copy-btn secondary" data-copy-target="solo-n">Copy</button>
        </div>
        <div class="field-line">
          <span class="label">å…¬é–‹éµ e</span>
          <span class="value" id="solo-e"></span>
          <button class="copy-btn secondary" data-copy-target="solo-e">Copy</button>
        </div>
        <div class="field-line">
          <span class="label">ç§˜å¯†éµ d</span>
          <span class="value" id="solo-d"></span>
          <button class="copy-btn secondary" data-copy-target="solo-d">Copy</button>
        </div>
      </div>

      <hr />

      <!-- æš—å·åŒ– -->
      <h3>2. æš—å·åŒ–</h3>
      <div class="row">
        <div class="col">
          <label for="solo-enc-n">å…¬é–‹éµ n</label>
          <input type="text" id="solo-enc-n" placeholder="ä¸Šã§ä½œã£ãŸ n ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™">
        </div>
        <div class="col">
          <label for="solo-enc-e">å…¬é–‹éµ e</label>
          <input type="text" id="solo-enc-e" placeholder="ä¸Šã§ä½œã£ãŸ e ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™">
        </div>
        <div class="col">
          <label for="solo-plain">å¹³æ–‡ (Aã€œZ, 0ã€œ9 / æœ€å¤§5æ–‡å­—)</label>
          <input type="text" id="solo-plain" maxlength="5" placeholder="ä¾‹: HELLO">
        </div>
      </div>
      <button id="solo-enc-btn">æš—å·åŒ–</button>
      <div id="solo-enc-output"></div>

      <hr />

      <!-- å¾©å· -->
      <h3>3. å¾©å·</h3>
      <div class="row">
        <div class="col">
          <label for="solo-dec-n">å…¬é–‹éµ n</label>
          <input type="text" id="solo-dec-n" placeholder="ä¸Šã§ä½œã£ãŸ n ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™">
        </div>
        <div class="col">
          <label for="solo-dec-d">ç§˜å¯†éµ d</label>
          <input type="text" id="solo-dec-d" placeholder="ä¸Šã§ä½œã£ãŸ d ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™">
        </div>
        <div class="col">
          <label for="solo-dec-c">æš—å·æ–‡ (Base64)</label>
          <textarea id="solo-dec-c" placeholder="æš—å·æ–‡ãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™"></textarea>
        </div>
      </div>
      <button id="solo-dec-btn">å¾©å·</button>
      <div id="solo-dec-msg"></div>
    </div>
  </div>

  <script>
    // ==== RSA ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆJavaScript / BigIntï¼‰ ====

    const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    const CHAR_TO_VAL = new Map();
    const VAL_TO_CHAR = [];
    for (let i = 0; i < ALPHABET.length; i++) {
      CHAR_TO_VAL.set(ALPHABET[i], BigInt(i));
      VAL_TO_CHAR.push(ALPHABET[i]);
    }

    // ç´ æ•°ç”Ÿæˆï¼ˆã‚¨ãƒ©ãƒˆã‚¹ãƒ†ãƒã‚¹ï¼‰
    function generatePrimes(limit) {
      const sieve = new Array(limit + 1).fill(true);
      sieve[0] = sieve[1] = false;
      for (let i = 2; i * i <= limit; i++) {
        if (sieve[i]) {
          for (let j = i * i; j <= limit; j += i) {
            sieve[j] = false;
          }
        }
      }
      const res = [];
      for (let i = 2; i <= limit; i++) {
        if (sieve[i]) res.push(i);
      }
      return res;
    }

    function gcdBigInt(a, b) {
      a = BigInt(a);
      b = BigInt(b);
      while (b !== 0n) {
        const t = b;
        b = a % b;
        a = t;
      }
      return a < 0n ? -a : a;
    }

    function egcd(a, b) {
      if (b === 0n) {
        return { x: 1n, y: 0n, g: a };
      }
      const { x: x1, y: y1, g } = egcd(b, a % b);
      return { x: y1, y: x1 - (a / b) * y1, g };
    }

    function modInverse(a, m) {
      a = BigInt(a);
      m = BigInt(m);
      const { x, g } = egcd(a, m);
      if (g !== 1n) return null;
      let res = x % m;
      if (res < 0n) res += m;
      return res;
    }

    function modPow(base, exp, mod) {
      base = BigInt(base) % BigInt(mod);
      exp = BigInt(exp);
      mod = BigInt(mod);
      let result = 1n;
      while (exp > 0n) {
        if (exp & 1n) {
          result = (result * base) % mod;
        }
        base = (base * base) % mod;
        exp >>= 1n;
      }
      return result;
    }

    function autoSelectE(phi, p, q) {
      phi = BigInt(phi);
      p = BigInt(p);
      q = BigInt(q);
      for (let i = 5001n; i < 6000n; i++) {
        if (gcdBigInt(i, phi) === 1n && i !== p && i !== q) {
          return i;
        }
      }
      return null;
    }

    function bigIntToBytes(num, size) {
      let n = BigInt(num);
      const bytes = new Uint8Array(size);
      for (let i = size - 1; i >= 0; i--) {
        bytes[i] = Number(n & 0xffn);
        n >>= 8n;
      }
      return bytes;
    }

    function bytesToBigInt(bytes) {
      let n = 0n;
      for (let i = 0; i < bytes.length; i++) {
        n = (n << 8n) + BigInt(bytes[i]);
      }
      return n;
    }

    function bytesToBase64(bytes) {
      let binary = "";
      for (let i = 0; i < bytes.length; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary);
    }

    function base64ToBytes(b64) {
      const binary = atob(b64.trim());
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes;
    }

    function encryptBlocks(plaintext, n, e) {
      n = BigInt(n);
      e = BigInt(e);
      const bitLen = n.toString(2).length;
      const size = Math.ceil(bitLen / 8);
      const allBytes = [];
      for (const c of plaintext) {
        const v = CHAR_TO_VAL.get(c);
        if (v === undefined) {
          throw new Error("ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚");
        }
        const cval = modPow(v, e, n);
        const blockBytes = bigIntToBytes(cval, size);
        for (const b of blockBytes) {
          allBytes.push(b);
        }
      }
      return bytesToBase64(new Uint8Array(allBytes));
    }

    function decryptBlocks(b64, n, d) {
      n = BigInt(n);
      d = BigInt(d);
      const bytes = base64ToBytes(b64);
      const bitLen = n.toString(2).length;
      const size = Math.ceil(bitLen / 8);
      if (size === 0 || bytes.length % size !== 0) {
        throw new Error("ãƒ–ãƒ­ãƒƒã‚¯é•·ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼ˆéµ n ãŒé•ã†å¯èƒ½æ€§ï¼‰ã€‚");
      }
      let result = "";
      for (let i = 0; i < bytes.length; i += size) {
        const block = bytes.slice(i, i + size);
        const m = modPow(bytesToBigInt(block), d, n);
        if (m < 0n || m >= BigInt(ALPHABET.length)) {
          throw new Error("å¾©å·å€¤ãŒæƒ³å®šç¯„å›²å¤–ã§ã™ï¼ˆéµã®çµ„ã¿åˆã‚ã›ã‚’ç¢ºèªï¼‰ã€‚");
        }
        result += VAL_TO_CHAR[Number(m)];
      }
      return result;
    }

    // ==== UI åˆæœŸåŒ– ====

    const primes = generatePrimes(6000).filter(p => p >= 5000 && p <= 6000);

    function fillPrimeSelect(id) {
      const sel = document.getElementById(id);
      sel.innerHTML = "";
      for (const p of primes) {
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
      }
    }

    fillPrimeSelect("recv-p");
    fillPrimeSelect("recv-q");
    fillPrimeSelect("solo-p");
    fillPrimeSelect("solo-q");

    const receiverSection = document.getElementById("receiver-section");
    const senderSection = document.getElementById("sender-section");
    const soloSection = document.getElementById("solo-section");

    document.querySelectorAll(".role-tab").forEach(tab => {
      tab.addEventListener("click", () => {
        document.querySelectorAll(".role-tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");
        const role = tab.getAttribute("data-role");
        receiverSection.style.display = role === "receiver" ? "" : "none";
        senderSection.style.display = role === "sender" ? "" : "none";
        soloSection.style.display = role === "solo" ? "" : "none";
      });
    });

    // ==== å—ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ ====
    let recvN = null, recvE = null, recvD = null;

    function updateRecvEDisplay() {
      const p = Number(document.getElementById("recv-p").value);
      const q = Number(document.getElementById("recv-q").value);
      const eDiv = document.getElementById("recv-e-display");
      if (p === q) {
        eDiv.innerHTML = "<code>p ã¨ q ã¯ç•°ãªã‚‹ç´ æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</code>";
        return;
      }
      const phi = BigInt(p - 1) * BigInt(q - 1);
      const e = autoSelectE(phi, p, q);
      if (e === null) {
        eDiv.innerHTML = "<code>æ¡ä»¶ã‚’æº€ãŸã™ e ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</code>";
      } else {
        eDiv.innerHTML = "<code>" + e.toString() + "</code>";
      }
    }
    document.getElementById("recv-p").addEventListener("change", updateRecvEDisplay);
    document.getElementById("recv-q").addEventListener("change", updateRecvEDisplay);
    updateRecvEDisplay();

    document.getElementById("recv-generate-btn").addEventListener("click", () => {
      const msgDiv = document.getElementById("recv-generate-msg");
      msgDiv.innerHTML = "";
      const p = Number(document.getElementById("recv-p").value);
      const q = Number(document.getElementById("recv-q").value);
      if (p === q) {
        msgDiv.innerHTML = '<div class="msg error">p ã¨ q ã¯ç•°ãªã‚‹ç´ æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>';
        return;
      }
      const phi = BigInt(p - 1) * BigInt(q - 1);
      const e = autoSelectE(phi, p, q);
      if (e === null) {
        msgDiv.innerHTML = '<div class="msg error">e ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚p, q ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</div>';
        return;
      }
      const n = BigInt(p) * BigInt(q);
      const d = modInverse(e, phi);
      if (d === null) {
        msgDiv.innerHTML = '<div class="msg error">dï¼ˆé€†å…ƒï¼‰ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        return;
      }
      recvN = n; recvE = e; recvD = d;
      document.getElementById("recv-n").textContent = n.toString();
      document.getElementById("recv-e").textContent = e.toString();
      document.getElementById("recv-d").textContent = d.toString();
      document.getElementById("recv-keys").style.display = "";
      msgDiv.innerHTML = '<div class="msg success">éµç”Ÿæˆå®Œäº†ã€‚å…¬é–‹éµ (n, e) ã‚’é€ä¿¡è€…ã«çŸ¥ã‚‰ã›ã€ç§˜å¯†éµ d ã¯è‡ªåˆ†ã ã‘ã§ä¿å­˜ã—ã¾ã™ã€‚</div>';

      document.getElementById("dec-n").value = n.toString();
      document.getElementById("dec-d").value = d.toString();
    });

    document.getElementById("dec-btn").addEventListener("click", () => {
      const nStr = document.getElementById("dec-n").value.trim();
      const dStr = document.getElementById("dec-d").value.trim();
      const cStr = document.getElementById("dec-c").value.trim();
      const msgDiv = document.getElementById("dec-msg");
      msgDiv.innerHTML = "";
      try {
        if (!nStr || !dStr || !cStr) {
          throw new Error("n, d, æš—å·æ–‡ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
        const plain = decryptBlocks(cStr, nStr, dStr);
        msgDiv.innerHTML = '<div class="msg success">å¾©å·çµæœ: ' + plain + '</div>';
      } catch (e) {
        msgDiv.innerHTML = '<div class="msg error">å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message + '</div>';
      }
    });

    // ==== é€ä¿¡è€…ãƒ¢ãƒ¼ãƒ‰ ====
    document.getElementById("sender-enc-btn").addEventListener("click", () => {
      const nStr = document.getElementById("sender-enc-n").value.trim();
      const eStr = document.getElementById("sender-enc-e").value.trim();
      const plainRaw = document.getElementById("sender-plain").value.trim();
      const outDiv = document.getElementById("sender-enc-output");
      outDiv.innerHTML = "";
      try {
        if (!nStr || !eStr) {
          throw new Error("å—ä¿¡è€…ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ n, e ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
        const plain = (plainRaw || "").toUpperCase();
        if (!/^[A-Z0-9]{1,5}$/.test(plain)) {
          throw new Error("å¹³æ–‡ã¯ Aã€œZ ã¨ 0ã€œ9 ã®ã¿ã€1ã€œ5æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
        const b64 = encryptBlocks(plain, nStr, eStr);
        outDiv.innerHTML =
          '<div class="msg success">æš—å·æ–‡ (Base64):<br><code>' + b64 + '</code></div>';
      } catch (e) {
        outDiv.innerHTML = '<div class="msg error">æš—å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message + '</div>';
      }
    });

    // ==== ä¸€äººã§è¡Œã†ãƒ¢ãƒ¼ãƒ‰ ====
    let soloN = null, soloE = null, soloD = null;

    function updateSoloEDisplay() {
      const p = Number(document.getElementById("solo-p").value);
      const q = Number(document.getElementById("solo-q").value);
      const eDiv = document.getElementById("solo-e-display");
      if (p === q) {
        eDiv.innerHTML = "<code>p ã¨ q ã¯ç•°ãªã‚‹ç´ æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</code>";
        return;
      }
      const phi = BigInt(p - 1) * BigInt(q - 1);
      const e = autoSelectE(phi, p, q);
      if (e === null) {
        eDiv.innerHTML = "<code>æ¡ä»¶ã‚’æº€ãŸã™ e ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</code>";
      } else {
        eDiv.innerHTML = "<code>" + e.toString() + "</code>";
      }
    }
    document.getElementById("solo-p").addEventListener("change", updateSoloEDisplay);
    document.getElementById("solo-q").addEventListener("change", updateSoloEDisplay);
    updateSoloEDisplay();

    document.getElementById("solo-generate-btn").addEventListener("click", () => {
      const msgDiv = document.getElementById("solo-generate-msg");
      msgDiv.innerHTML = "";
      const p = Number(document.getElementById("solo-p").value);
      const q = Number(document.getElementById("solo-q").value);
      if (p === q) {
        msgDiv.innerHTML = '<div class="msg error">p ã¨ q ã¯ç•°ãªã‚‹ç´ æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>';
        return;
      }
      const phi = BigInt(p - 1) * BigInt(q - 1);
      const e = autoSelectE(phi, p, q);
      if (e === null) {
        msgDiv.innerHTML = '<div class="msg error">e ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã€‚p, q ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚</div>';
        return;
      }
      const n = BigInt(p) * BigInt(q);
      const d = modInverse(e, phi);
      if (d === null) {
        msgDiv.innerHTML = '<div class="msg error">dï¼ˆé€†å…ƒï¼‰ãŒæ±‚ã¾ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        return;
      }
      soloN = n; soloE = e; soloD = d;
      document.getElementById("solo-n").textContent = n.toString();
      document.getElementById("solo-e").textContent = e.toString();
      document.getElementById("solo-d").textContent = d.toString();
      document.getElementById("solo-keys").style.display = "";
      msgDiv.innerHTML = '<div class="msg success">éµç”Ÿæˆå®Œäº†ã€‚ã“ã®éµã‚’ä½¿ã£ã¦æš—å·åŒ–ãƒ»å¾©å·ã‚’è©¦ã›ã¾ã™ã€‚</div>';

      document.getElementById("solo-enc-n").value = n.toString();
      document.getElementById("solo-enc-e").value = e.toString();
      document.getElementById("solo-dec-n").value = n.toString();
      document.getElementById("solo-dec-d").value = d.toString();
    });

    document.getElementById("solo-enc-btn").addEventListener("click", () => {
      const nStr = document.getElementById("solo-enc-n").value.trim();
      const eStr = document.getElementById("solo-enc-e").value.trim();
      const plainRaw = document.getElementById("solo-plain").value.trim();
      const outDiv = document.getElementById("solo-enc-output");
      outDiv.innerHTML = "";
      try {
        if (!nStr || !eStr) {
          throw new Error("n ã¨ e ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¸Šã®éµç”Ÿæˆã§è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼‰ã€‚");
        }
        const plain = (plainRaw || "").toUpperCase();
        if (!/^[A-Z0-9]{1,5}$/.test(plain)) {
          throw new Error("å¹³æ–‡ã¯ Aã€œZ ã¨ 0ã€œ9 ã®ã¿ã€1ã€œ5æ–‡å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
        const b64 = encryptBlocks(plain, nStr, eStr);
        outDiv.innerHTML =
          '<div class="msg success">æš—å·æ–‡ (Base64):<br><code>' + b64 + '</code></div>';
        document.getElementById("solo-dec-c").value = b64;
      } catch (e) {
        outDiv.innerHTML = '<div class="msg error">æš—å·åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message + '</div>';
      }
    });

    document.getElementById("solo-dec-btn").addEventListener("click", () => {
      const nStr = document.getElementById("solo-dec-n").value.trim();
      const dStr = document.getElementById("solo-dec-d").value.trim();
      const cStr = document.getElementById("solo-dec-c").value.trim();
      const msgDiv = document.getElementById("solo-dec-msg");
      msgDiv.innerHTML = "";
      try {
        if (!nStr || !dStr || !cStr) {
          throw new Error("n, d, æš—å·æ–‡ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
        const plain = decryptBlocks(cStr, nStr, dStr);
        msgDiv.innerHTML = '<div class="msg success">å¾©å·çµæœ: ' + plain + '</div>';
      } catch (e) {
        msgDiv.innerHTML = '<div class="msg error">å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message + '</div>';
      }
    });

    // Copy ãƒœã‚¿ãƒ³
    document.querySelectorAll(".copy-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const targetId = btn.getAttribute("data-copy-target");
        const el = document.getElementById(targetId);
        const text = el ? el.textContent.trim() : "";
        if (!text) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).catch(() => {});
        } else {
          const temp = document.createElement("textarea");
          temp.value = text;
          document.body.appendChild(temp);
          temp.select();
          try { document.execCommand("copy"); } catch (_) {}
          document.body.removeChild(temp);
        }
      });
    });
  </script>
</body>
</html>
