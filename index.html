<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>PrimeGuard RSA</title>
    <link rel="stylesheet" href="style.css">

    <!-- 数学計算用（mod逆元などで使用） -->
    <script>
        // --- 素数リスト作成（5000〜6000） ---
        function generatePrimes(max) {
            const sieve = Array(max + 1).fill(true);
            sieve[0] = sieve[1] = false;
            for (let i = 2; i * i <= max; i++) {
                if (sieve[i]) {
                    for (let j = i * i; j <= max; j += i) {
                        sieve[j] = false;
                    }
                }
            }
            return [...Array(max + 1).keys()].filter(i => sieve[i] && i >= 5000);
        }
        const primes = generatePrimes(6000);

        // gcd
        function gcd(a, b) {
            while (b !== 0) {
                [a, b] = [b, a % b];
            }
            return a;
        }

        // 拡張 Euclid（mod 逆元）
        function modInverse(a, m) {
            function egcd(a, b) {
                if (b === 0) return [1, 0, a];
                const [x1, y1, g] = egcd(b, a % b);
                return [y1, x1 - Math.floor(a / b) * y1, g];
            }
            let [x, y, g] = egcd(a, m);
            if (g !== 1) return null;
            return (x % m + m) % m;
        }

        // e を自動選択
        function autoSelectE(phi, p, q) {
            for (let e = 5001; e < 6000; e++) {
                if (gcd(e, phi) === 1 && e !== p && e !== q) {
                    return e;
                }
            }
            return null;
        }

        // --- 文字集合（A-Z, 0-9） ---
        const ALPHABET = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        const CHAR_TO_VAL = {};
        [...ALPHABET].forEach((ch, i) => CHAR_TO_VAL[ch] = i);

        // 暗号化（1 文字ずつ RSA）
        function encryptBlocks(text, n, e) {
            const size = Math.ceil((Number(n).toString(2).length) / 8);
            const bytes = [];

            for (const c of text) {
                const m = CHAR_TO_VAL[c];
                const enc = BigInt(m) ** BigInt(e) % BigInt(n);
                let block = enc.toString(16);
                if (block.length % 2 === 1) block = "0" + block;
                const buf = hexToBytes(block);
                while (buf.length < size) buf.unshift(0);
                bytes.push(...buf);
            }
            return btoa(String.fromCharCode(...bytes));
        }

        // 復号
        function decryptBlocks(b64, n, d) {
            const data = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
            const size = Math.ceil((Number(n).toString(2).length) / 8);
            if (data.length % size !== 0) throw Error("ブロック長が一致しません");

            let res = "";
            for (let i = 0; i < data.length; i += size) {
                const block = data.slice(i, i + size);
                const hex = [...block].map(x => x.toString(16).padStart(2, "0")).join("");
                const m = BigInt("0x" + hex) ** BigInt(d) % BigInt(n);
                const mi = Number(m);
                if (mi < 0 || mi >= ALPHABET.length) throw Error("復号値が範囲外です");
                res += ALPHABET[mi];
            }
            return res;
        }

        function hexToBytes(hex) {
            const arr = [];
            for (let i = 0; i < hex.length; i += 2) {
                arr.push(parseInt(hex.substring(i, i + 2), 16));
            }
            return arr;
        }

        // --- セレクトボックスに素数を入れる ---
        window.addEventListener("DOMContentLoaded", () => {
            ["recv-p", "recv-q", "solo-p", "solo-q"].forEach(id => {
                const sel = document.getElementById(id);
                primes.forEach(p => {
                    const opt = document.createElement("option");
                    opt.value = p;
                    opt.textContent = p;
                    sel.appendChild(opt);
                });
            });
        });
    </script>
</head>

<body>

    <!-- ヘッダー -->
    <header class="header">
        <h1>PrimeGuard RSA</h1>
        <p>高校生向けに RSA 暗号の仕組みを体験できる教材</p>
    </header>

    <div class="container">

        <!-- RSA 前提説明 -->
        <section class="section">
            <h2>RSA の前提</h2>

            <div class="rsa-note">
                <p class="rsa-note-title">このツールで使う RSA の前提</p>
                <ol>
                    <li>暗号化する側に渡されるのは公開鍵 <code>n, e</code> のみ。</li>
                    <li><code>p, q, e</code> の 3 つが揃うと暗号文を復号できる。</li>
                    <li><code>n = p × q</code>（ただし <code>p, q</code> は素数）。</li>
                </ol>

                <p class="rsa-note-title" style="margin-top:0.5rem;">e の求め方</p>
                <ul class="rsa-note-list">
                    <li><code>φ(n) = (p - 1)(q - 1)</code> を計算する。</li>
                    <li><code>1 &lt; e &lt; φ(n)</code> を満たす整数から選ぶ。</li>
                    <li><code>gcd(e, φ(n)) = 1</code>（互いに素）であること。</li>
                    <li>このツールでは <code>5001〜5999</code> の中から条件を満たす e を自動で選ぶ。</li>
                </ul>
            </div>

            <!-- 役割選択 -->
            <h3>役割を選択</h3>
            <div class="role-select">
                <label><input type="radio" name="role" value="receiver" checked> 受信者（鍵を作る）</label>
                <label><input type="radio" name="role" value="sender"> 送信者（公開鍵で暗号化）</label>
                <label><input type="radio" name="role" value="solo"> 一人で行う</label>
            </div>
        </section>

        <!-- 受信者モード -->
        <section class="section" id="receiver-section">
            <h2>1. 鍵生成（受信者）</h2>

            <div class="flex">
                <div>
                    <label>素数 p</label>
                    <select id="recv-p"></select>
                </div>
                <div>
                    <label>素数 q</label>
                    <select id="recv-q"></select>
                </div>
            </div>

            <button id="recv-generate-btn">鍵生成</button>
            <p id="recv-generate-msg" class="message"></p>

            <div id="recv-keys" style="display:none;">
                <p>公開鍵 n：<span id="recv-n"></span></p>
                <p>公開鍵 e：<span id="recv-e"></span></p>
                <p>秘密鍵 d：<span id="recv-d"></span></p>
                <p class="small-note">※上の値をコピーして送信者へ渡してください</p>
            </div>

            <h3>2. 復号（受信者）</h3>
            <div class="flex">
                <div>
                    <label>公開鍵 n</label>
                    <input id="dec-n" placeholder="n を貼り付け">
                </div>
                <div>
                    <label>秘密鍵 d</label>
                    <input id="dec-d" placeholder="d を貼り付け">
                </div>
            </div>

            <label>暗号文（Base64）</label>
            <textarea id="dec-c" placeholder="暗号文を貼り付け"></textarea>

            <button id="dec-btn">復号</button>
            <p id="dec-msg" class="message"></p>
        </section>

        <!-- 送信者モード -->
        <section class="section" id="sender-section" style="display:none;">
            <h2>1. 受信者から公開鍵をもらう</h2>

            <div class="flex">
                <div>
                    <label>公開鍵 n</label>
                    <input id="sender-n">
                </div>
                <div>
                    <label>公開鍵 e</label>
                    <input id="sender-e">
                </div>
            </div>

            <h3>2. 暗号化</h3>
            <label>平文（A–Z, 0–9）最大5文字</label>
            <input id="sender-plain" maxlength="5">

            <button id="sender-enc-btn">暗号化</button>
            <p id="sender-enc-msg" class="message"></p>
        </section>

        <!-- 一人で行うモード -->
        <section class="section" id="solo-section" style="display:none;">
            <h2>1. 鍵生成</h2>

            <div class="flex">
                <div>
                    <label>素数 p</label>
                    <select id="solo-p"></select>
                </div>
                <div>
                    <label>素数 q</label>
                    <select id="solo-q"></select>
                </div>
            </div>

            <button id="solo-generate-btn">鍵生成</button>
            <p id="solo-generate-msg" class="message"></p>

            <div id="solo-keys" style="display:none;">
                <p>公開鍵 n：<span id="solo-n"></span></p>
                <p>公開鍵 e：<span id="solo-e"></span></p>
                <p>秘密鍵 d：<span id="solo-d"></span></p>
            </div>

            <h3>2. 暗号化</h3>

            <div class="flex">
                <div>
                    <label>公開鍵 n</label>
                    <input id="solo-enc-n">
                </div>
                <div>
                    <label>公開鍵 e</label>
                    <input id="solo-enc-e">
                </div>
            </div>

            <label>平文</label>
            <input id="solo-plain" maxlength="5">

            <button id="solo-enc-btn">暗号化</button>
            <p id="solo-enc-msg" class="message"></p>

            <h3>3. 復号</h3>

            <div class="flex">
                <div>
                    <label>公開鍵 n</label>
                    <input id="solo-dec-n">
                </div>
                <div>
                    <label>秘密鍵 d</label>
                    <input id="solo-dec-d">
                </div>
            </div>

            <label>暗号文</label>
            <textarea id="solo-dec-c"></textarea>

            <button id="solo-dec-btn">復号</button>
            <p id="solo-dec-msg" class="message"></p>
        </section>

    </div>

    <script>
        // モード切り替え
        document.querySelectorAll("input[name='role']").forEach(r => {
            r.addEventListener("change", () => {
                document.getElementById("receiver-section").style.display = r.value === "receiver" ? "block" : "none";
                document.getElementById("sender-section").style.display = r.value === "sender" ? "block" : "none";
                document.getElementById("solo-section").style.display = r.value === "solo" ? "block" : "none";
            });
        });

        // --- 受信者：鍵生成 ---
        document.getElementById("recv-generate-btn").addEventListener("click", () => {
            const p = Number(document.getElementById("recv-p").value);
            const q = Number(document.getElementById("recv-q").value);
            const msg = document.getElementById("recv-generate-msg");

            if (p === q) {
                msg.textContent = "p と q は異なる素数を選んでください。";
                msg.className = "message error";
                return;
            }

            const phi = (p - 1) * (q - 1);
            const e = autoSelectE(phi, p, q);
            if (!e) {
                msg.textContent = "利用できる e がありません。";
                msg.className = "message error";
                return;
            }

            const n = BigInt(p) * BigInt(q);
            const d = modInverse(e, phi);

            document.getElementById("recv-n").textContent = n;
            document.getElementById("recv-e").textContent = e;
            document.getElementById("recv-d").textContent = d;
            document.getElementById("recv-keys").style.display = "block";

            msg.textContent = "鍵生成完了。上の値をコピーして使ってください。";
            msg.className = "message success";
        });

        // --- 受信者：復号 ---
        document.getElementById("dec-btn").addEventListener("click", () => {
            const n = BigInt(document.getElementById("dec-n").value);
            const d = BigInt(document.getElementById("dec-d").value);
            const cipher = document.getElementById("dec-c").value;
            const msg = document.getElementById("dec-msg");

            try {
                const plain = decryptBlocks(cipher, n, d);
                msg.textContent = "復号結果：" + plain;
                msg.className = "message success";
            } catch (e) {
                msg.textContent = "復号に失敗：" + e;
                msg.className = "message error";
            }
        });

        // --- 送信者モード：暗号化 ---
        document.getElementById("sender-enc-btn").addEventListener("click", () => {
            const n = BigInt(document.getElementById("sender-n").value);
            const e = Number(document.getElementById("sender-e").value);
            const text = document.getElementById("sender-plain").value.toUpperCase();
            const msg = document.getElementById("sender-enc-msg");

            if (!/^[A-Z0-9]{1,5}$/.test(text)) {
                msg.textContent = "平文は A-Z, 0-9 の 1〜5 文字で入力してください。";
                msg.className = "message error";
                return;
            }

            try {
                const cipher = encryptBlocks(text, n, e);
                msg.textContent = "暗号文：" + cipher;
                msg.className = "message success";
            } catch (e) {
                msg.textContent = "暗号化に失敗：" + e;
                msg.className = "message error";
            }
        });

        // --- 一人でモード：鍵生成 ---
        document.getElementById("solo-generate-btn").addEventListener("click", () => {
            const p = Number(document.getElementById("solo-p").value);
            const q = Number(document.getElementById("solo-q").value);
            const msg = document.getElementById("solo-generate-msg");

            if (p === q) {
                msg.textContent = "p と q は異なる素数を選んでください。";
                msg.className = "message error";
                return;
            }

            const phi = (p - 1) * (q - 1);
            const e = autoSelectE(phi, p, q);
            if (!e) {
                msg.textContent = "利用できる e がありません。";
                msg.className = "message error";
                return;
            }

            const n = BigInt(p) * BigInt(q);
            const d = modInverse(e, phi);

            document.getElementById("solo-n").textContent = n;
            document.getElementById("solo-e").textContent = e;
            document.getElementById("solo-d").textContent = d;
            document.getElementById("solo-keys").style.display = "block";

            msg.textContent = "鍵生成完了。上の値をコピーして使ってください。";
            msg.className = "message success";
        });

        // --- 一人でモード：暗号化 ---
        document.getElementById("solo-enc-btn").addEventListener("click", () => {
            const n = BigInt(document.getElementById("solo-enc-n").value);
            const e = Number(document.getElementById("solo-enc-e").value);
            const text = document.getElementById("solo-plain").value.toUpperCase();
            const msg = document.getElementById("solo-enc-msg");

            if (!/^[A-Z0-9]{1,5}$/.test(text)) {
                msg.textContent = "A-Z, 0-9 の 1〜5 文字で入力してください。";
                msg.className = "message error";
                return;
            }

            try {
                const cipher = encryptBlocks(text, n, e);
                msg.textContent = "暗号文：" + cipher;
                msg.className = "message success";
            } catch (e) {
                msg.textContent = "暗号化に失敗：" + e;
                msg.className = "message error";
            }
        });

        // --- 一人でモード：復号 ---
        document.getElementById("solo-dec-btn").addEventListener("click", () => {
            const n = BigInt(document.getElementById("solo-dec-n").value);
            const d = BigInt(document.getElementById("solo-dec-d").value);
            const cipher = document.getElementById("solo-dec-c").value;
            const msg = document.getElementById("solo-dec-msg");

            try {
                const plain = decryptBlocks(cipher, n, d);
                msg.textContent = "復号結果：" + plain;
                msg.className = "message success";
            } catch (e) {
                msg.textContent = "復号に失敗：" + e;
                msg.className = "message error";
            }
        });

    </script>

</body>
</html>
